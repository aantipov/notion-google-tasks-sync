---
import Layout from '@/layouts/Layout.astro';
import Hero from '@/components/Hero/Hero.astro';
import Main from '@/components/Main.tsx';
import { decodeJWTTokens } from '@/helpers/decodeJWTTokens';

export const prerender = false;

const { JWT_SECRET } = Astro.locals.runtime.env;
const gJwtToken = Astro.cookies.get('gtoken')?.value;
const nJwtToken = Astro.cookies.get('ntoken')?.value;
let hasGToken = false;
try {
	const tokens = await decodeJWTTokens(gJwtToken, nJwtToken, JWT_SECRET);
	hasGToken = !!tokens.gToken;
} catch (error) {
	console.error('Error while decoding JWT tokens', error);
	Astro.cookies.set('gtoken', '', { expires: new Date(0) });
	Astro.cookies.set('ntoken', '', { expires: new Date(0) });
}
const isFeatureEnabled =
	Astro.url.hostname !== 'notion-google-tasks-sync.com' ||
	Astro.url.searchParams.get('q') === '123';
const isUserDeniedGAccess =
	Astro.url.searchParams.get('error') === 'gaccess_denied';
const isUserDeniedNAccess =
	Astro.url.searchParams.get('error') === 'naccess_denied';
const isGAuthError = Astro.url.searchParams.get('error') === 'gaccess_error';
const isNAuthError = Astro.url.searchParams.get('error') === 'naccess_error';
---

<Layout
	isUserDeniedGAccess={isUserDeniedGAccess}
	isUserDeniedNAccess={isUserDeniedNAccess}
	isGAuthError={isGAuthError}
	isNAuthError={isNAuthError}
>
	<Hero />

	<section class="my-32 flex flex-col items-center justify-center">
		<h1
			id="start-sync"
			class="text-5xl font-bold tracking-wide sm:text-6xl md:px-20 lg:text-6xl xl:text-6xl"
		>
			Start Syncing
			<div class="mt-2 text-center text-3xl">in 3 steps</div>
		</h1>

		<div
			class="mx-auto mt-6 max-w-md rounded-lg bg-orange-200 p-4 text-orange-800 shadow-md"
			role="alert"
		>
			<p class="font-semibold">Notice of Service Interruption</p>
			<p>
				We're currently experiencing difficulties with our Notion integration.
				Please enter your email below and hit 'Submit.' We'll notify you as soon
				as everything is back on track. Thank you for your patience and
				understanding.
			</p>
			<iframe
				data-tally-src="https://tally.so/embed/w8xyLo?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
				loading="lazy"
				width="100%"
				height="362"
				frameborder="0"
				marginheight="0"
				marginwidth="0"
				title="My feedback form"></iframe><script is:inline>
				var d = document,
					w = 'https://tally.so/widgets/embed.js',
					v = function () {
						'undefined' != typeof Tally
							? Tally.loadEmbeds()
							: d
									.querySelectorAll('iframe[data-tally-src]:not([src])')
									.forEach(function (e) {
										e.src = e.dataset.tallySrc;
									});
					};
				if ('undefined' != typeof Tally) v();
				else if (d.querySelector('script[src="' + w + '"]') == null) {
					var s = d.createElement('script');
					(s.src = w), (s.onload = v), (s.onerror = v), d.body.appendChild(s);
				}
			</script>
		</div>

		<Main
			client:load
			hasToken={!!hasGToken}
			isFeatureEnabled={isFeatureEnabled}
		/>
	</section>

	<section class="mb-36 mt-24 flex flex-col items-center justify-center">
		<h1
			class="px-8 text-5xl font-bold tracking-wide sm:px-8 sm:text-6xl md:px-20 lg:px-4 lg:text-6xl xl:text-6xl"
		>
			Limitations
		</h1>
		<div class="mt-8 flex w-full max-w-2xl justify-center">
			<ul class="list-disc space-y-2 pl-6">
				<li>
					Only tasks' "<span class="font-mono">Title</span>", "<span
						class="font-mono">Date</span
					>", and "<span class="font-mono">Status</span>" properties are synced.
					Tasks descriptions are not synced.
				</li>
				<li>Tasks hierarchy is not supported.</li>
				<li>No support for multiple Google Tasklists and Notion databases.</li>
				<li>
					Synchronizaion of tasks' time is unfortunately not supported due to
					the limitations of the Google Tasks API.
				</li>
				<li>
					Notion Database should be configured to have properties of the
					following types: "<span class="font-mono">Status</span>", "<span
						class="font-mono">Date</span
					>", "<span class="font-mono">Last edited time</span>" and "<span
						class="font-mono">Last Edited By</span
					>". "<span class="font-mono">Status</span>" property should have the
					following options: "<span class="font-mono">To Do</span>", "<span
						class="font-mono">Done</span
					>".
				</li>
			</ul>
		</div>
	</section>
</Layout>
